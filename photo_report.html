<!DOCTYPE html>
<html lang="en">
<head> 
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Audit Photo Report Generator</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#1a2a4a 0%,#0d1b35 100%);min-height:100vh;padding:0px 20px 20px 20px;}
.container{max-width:980px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.4);overflow:hidden;}
.app-header{background:linear-gradient(135deg,#1a2a4a 0%,#0d1b35 100%);color:#fff;padding:20px 30px;text-align:center;}
.app-header h1{font-size:21px;margin-bottom:5px;}
.app-header p{opacity:.85;font-size:12px;}
.content{padding:20px;}
.form-section{background:#f0f4fa;padding:8px 16px 10px 16px;border-radius:10px;margin-bottom:16px;border-left:4px solid #1a2a4a;}
.form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.form-group{display:flex;flex-direction:column;}
.form-group label{font-weight:600;margin-bottom:4px;color:#333;font-size:12px;}
.form-group input,.form-group select{padding:8px 10px;border:2px solid #c8d4e8;border-radius:6px;font-size:12px;transition:border-color .2s;}
.form-group input:focus,.form-group select:focus{outline:none;border-color:#1a2a4a;}

/* PHOTO SECTIONS */
.photos-label{font-size:13px;font-weight:600;color:#333;margin-bottom:7px;}
.photo-rows-wrapper{margin-bottom:14px;}

.photo-row-section{border:1px solid #c8d4e8;border-radius:6px;margin-bottom:8px;overflow:hidden;box-shadow:0 1px 4px rgba(26,42,74,.07);}
.photo-row{display:grid;grid-template-columns:repeat(3,1fr);}

/* BLOCK */
.photo-cell{border-right:1px solid #888;display:flex;flex-direction:column;position:relative;transition:opacity .2s,transform .2s;}
.photo-cell:last-child{border-right:none;}
.photo-cell.dragging{opacity:.4;transform:scale(.97);}
.photo-cell.drag-target{outline:3px dashed #1a2a4a;outline-offset:-2px;background:#e8eef8;}
.photo-cell.empty-cell{background:repeating-linear-gradient(45deg,#f9f9f9,#f9f9f9 5px,#f0f0f0 5px,#f0f0f0 10px);}

/* Block controls bar */
.block-controls{display:flex;align-items:center;justify-content:space-between;background:#f7f9fc;border-bottom:1px solid #e0e6f0;padding:3px 6px;gap:4px;}
.block-drag-handle{cursor:grab;color:#aab8d0;font-size:13px;padding:0 3px;user-select:none;flex-shrink:0;transition:color .15s;}
.block-drag-handle:hover{color:#1a2a4a;}
.block-drag-handle:active{cursor:grabbing;}
.block-delete-btn{background:transparent;color:#c0392b;border:1px solid #e8c0bc;border-radius:4px;padding:2px 7px;font-size:10px;cursor:pointer;font-weight:600;flex-shrink:0;transition:all .15s;}
.block-delete-btn:hover{background:#c0392b;color:#fff;border-color:#c0392b;}

.photo-upload-wrapper.drag-over{background:#d0daf5!important;outline:2px dashed #1a2a4a;}
.photo-upload-wrapper{position:relative;aspect-ratio:4/3;cursor:pointer;background:#f5f5f5;border-bottom:1px solid #888;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.photo-upload-wrapper:hover{background:#e8eef8;}
.photo-upload-wrapper.has-image{background:#000;}
.photo-upload-wrapper img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;display:none;}
.photo-upload-wrapper.has-image img{display:block;}
.upload-placeholder{text-align:center;pointer-events:none;}
.upload-placeholder span{font-size:26px;display:block;color:#ccc;}
.upload-placeholder p{font-size:10px;color:#bbb;margin-top:3px;}
.photo-upload-wrapper.has-image .upload-placeholder{display:none;}
.remove-btn{position:absolute;top:4px;right:4px;background:rgba(180,0,0,.85);color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:15px;display:none;line-height:22px;text-align:center;z-index:10;}
.photo-upload-wrapper.has-image .remove-btn{display:block;}
.rotate-btn{position:absolute;top:4px;right:30px;background:rgba(26,42,74,.85);color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:13px;display:none;line-height:22px;text-align:center;z-index:10;}
.photo-upload-wrapper.has-image .rotate-btn{display:block;}
input[type="file"]{display:none;}

.photo-meta{background:#fff;flex:1;}
.meta-desc{padding:2px 6px 1px;position:relative;display:flex;align-items:center;gap:4px;}
.meta-desc label{font-size:10px;font-weight:600;color:#333;display:block;margin-bottom:1px;}
.meta-comm{padding:1px 6px 3px;position:relative;display:flex;align-items:center;gap:4px;}
.meta-comm label{font-size:10px;font-weight:600;color:#333;display:block;margin-bottom:1px;}
.meta-divider{height:1px;background:#888;}
.meta-desc label{white-space:nowrap;flex-shrink:0;}
.meta-comm label{white-space:nowrap;flex-shrink:0;}
.meta-desc .combo-wrap{flex:1;}
.meta-comm .combo-wrap{flex:1;}

/* COMBO INPUT */
.combo-wrap{position:relative;}
.combo-input{width:100%;padding:2px 22px 2px 4px;border:1px solid #ddd;border-radius:3px;font-size:10px;font-family:Calibri,sans-serif;}
.combo-input:focus{outline:none;border-color:#1a2a4a;}
.combo-arrow{position:absolute;right:3px;top:50%;transform:translateY(-50%);cursor:pointer;color:#888;font-size:9px;padding:2px;user-select:none;}
.combo-arrow:hover{color:#1a2a4a;}
.combo-dropdown{position:fixed;background:#fff;border:1px solid #1a2a4a;border-radius:4px;z-index:99999;max-height:200px;overflow-y:auto;box-shadow:0 4px 16px rgba(0,0,0,.18);display:none;}
.combo-dropdown.open{display:block;}
.combo-item{padding:5px 8px;font-size:10px;cursor:pointer;color:#333;overflow:hidden;text-overflow:ellipsis;border-bottom:1px solid #f0f0f0;}
.combo-item:last-child{border-bottom:none;}
.combo-item:hover,.combo-item.highlighted{background:#e8eef8;color:#1a2a4a;padding-left:12px;transition:padding .1s;}
.combo-item.category{font-weight:700;color:#1a2a4a;background:#f0f4fa;cursor:default;font-size:9px;text-transform:uppercase;letter-spacing:.5px;}
.combo-item.no-match{color:#aaa;cursor:default;}

/* Row header */
.row-header{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(90deg,#1a2a4a,#2a3f6a);border-bottom:1px solid #1a2a4a;padding:4px 10px;}
.row-number{font-size:10px;font-weight:700;color:#fff;letter-spacing:.5px;text-transform:uppercase;}
.row-delete-btn{background:transparent;color:#ffb3ae;border:1px solid rgba(255,179,174,.4);border-radius:4px;padding:2px 8px;font-size:10px;cursor:pointer;font-weight:600;transition:all .15s;}
.row-delete-btn:hover{background:rgba(255,80,60,.7);color:#fff;border-color:transparent;}

.add-row-btn{width:100%;padding:9px;background:#e8eef8;border:2px dashed #1a2a4a;border-radius:8px;color:#1a2a4a;font-weight:600;cursor:pointer;font-size:12px;text-align:center;margin-bottom:14px;}
.add-row-btn:hover{background:#d0daf5;}

.action-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:0;}.action-buttons .btn:nth-child(5),.action-buttons .btn:nth-child(6){grid-column:span 1;}
.btn{padding:11px 14px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;gap:6px;}
.btn-primary{background:linear-gradient(135deg,#1a2a4a 0%,#0d1b35 100%);color:#fff;box-shadow:0 4px 12px rgba(13,27,53,.4);}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(13,27,53,.6);}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.btn-secondary{background:#fff;color:#1a2a4a;border:2px solid #1a2a4a;}
.btn-secondary:hover{background:#e8eef8;}
.status-message{padding:10px;border-radius:7px;margin-top:10px;display:none;text-align:center;font-weight:600;font-size:12px;}
.status-message.success{background:#d4edda;color:#155724;border:2px solid #c3e6cb;}
.status-message.error{background:#f8d7da;color:#721c24;border:2px solid #f5c6cb;}


@media(max-width:600px){
  .form-grid{grid-template-columns:1fr;}
  .photo-row{grid-template-columns:1fr;}
  .photo-cell{border-right:none;border-bottom:1px solid #888;}
  .photo-cell:last-child{border-bottom:none;}
  .action-buttons{grid-template-columns:1fr 1fr;}
  .session-buttons{grid-template-columns:1fr 1fr!important;}
  .container{border-radius:0;}
}

/* CONFIRM MODAL */
#confirmModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:999999;align-items:center;justify-content:center;}
#confirmModal.open{display:flex;}
#confirmBox{background:#fff;border-radius:10px;padding:22px 24px;max-width:320px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.25);}
#confirmBox p{font-size:13px;color:#1a2a4a;margin-bottom:14px;font-weight:500;}
#confirmDontAsk{display:flex;align-items:center;gap:6px;font-size:11px;color:#666;margin-bottom:16px;cursor:pointer;}
#confirmDontAsk input{cursor:pointer;}
#confirmBtns{display:flex;gap:8px;justify-content:flex-end;}
#confirmBtns button{padding:6px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:none;}
#confirmCancel{background:#f0f4fa;color:#1a2a4a;border:1.5px solid #c8d4e8!important;}
#confirmCancel:hover{background:#e0e8f5;}
#confirmOk{background:linear-gradient(135deg,#c0392b,#e74c3c);color:#fff;}
#confirmOk:hover{background:linear-gradient(135deg,#a93226,#c0392b);}

/* MOBILE COMBO EDIT */
.combo-edit-btn{background:none;border:none;cursor:pointer;font-size:10px;padding:0 2px;color:#aab8d0;flex-shrink:0;line-height:1;transition:color .15s;}
.combo-edit-btn:hover{color:#1a2a4a;}
.combo-edit-btn.active{color:#e26b0a;}
.combo-input.mobile-readonly{background:#f7f9fc;color:#444;cursor:pointer;}
@media(max-width:768px){
  .combo-dropdown{font-size:13px!important;}
  .combo-item{padding:10px 12px!important;font-size:13px!important;}
}

.q-btn{flex:1;padding:7px 4px;font-size:11px;border-radius:6px;border:1.5px solid #c8d4e8;background:#f8fafd;color:#1a2a4a;cursor:pointer;font-weight:600;text-align:center;}
.q-btn.active{background:#1a2a4a;color:#fff;border-color:#1a2a4a;}
</style>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body>
<div class="container">
  <div class="app-header">
    <h1 style="font-size:16px;margin-bottom:4px;">&#128248; Audit Photo Report Generator</h1>
    <p style="margin:0;font-size:11px;opacity:.8;">Create professional photo reports</p>
  </div>
  <div class="content">
    <div class="form-section">
      <div class="form-grid">
        <div class="form-group"><label>Factory Name *</label><input type="text" id="factoryName" placeholder="Enter factory name"></div>
        <div class="form-group"><label>Audit Type</label>
         <div class="combo-wrap" style="position:relative;">
  <input type="text" class="combo-input" id="auditType" value="Initial Audit" autocomplete="off" style="width:100%;padding:8px 22px 8px 10px;border:2px solid #c8d4e8;border-radius:6px;font-size:12px;">
  <span class="combo-arrow" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);cursor:pointer;color:#888;font-size:9px;user-select:none;">â–¼</span>
  <div class="combo-dropdown" id="auditTypeDropdown">
    <div class="combo-item" onclick="pickAuditType('Full Monitoring')">Full Monitoring</div>
    <div class="combo-item" onclick="pickAuditType('Partial Monitoring')">Partial Monitoring</div>
    <div class="combo-item" onclick="pickAuditType('Initial Audit')">Initial Audit</div>
    <div class="combo-item" onclick="pickAuditType('Follow-up Monitoring')">Follow-up Monitoring</div>
  </div>
</div>
        </div>
        <div class="form-group"><label>Eurofins CPA Office</label><input type="text" id="cpaOffice" value="Turkey"></div>
        <div class="form-group"><label>Audit Date *</label><input type="text" id="auditDate" placeholder="e.g. 07-08.02.2026"></div>
        <div class="form-group"><label>Customer *</label><input type="text" id="customer" placeholder="Enter customer name"></div>
        <div class="form-group"><label>Report Number *</label><input type="text" id="reportNumber" placeholder="e.g., TR_AKR_16"></div>
      </div>
    </div>


    <div style="margin-bottom:10px;">
      <button class="btn btn-primary" style="width:100%;" onclick="document.getElementById('uploadPhotosFile').click()">&#128444; Upload Photos<input type="file" id="uploadPhotosFile" accept="image/*" multiple style="display:none" onchange="uploadPhotos(event)"></button>
    </div>
    <div class="photos-label" style="display:flex;align-items:center;justify-content:space-between;">&#128247; Photo Sections <button onclick="reorganizeBlocks()" style="font-size:10px;padding:3px 10px;background:#e8eef8;border:1.5px solid #1a2a4a;border-radius:5px;color:#1a2a4a;font-weight:600;cursor:pointer;white-space:nowrap;margin-left:10px;" title="Mevcut fotoÄŸraflarÄ± gruplara gÃ¶re yeniden sÄ±rala">&#128260; Reorganize</button></div>
    <div id="rowsContainer" class="photo-rows-wrapper"></div>
    <div class="add-row-btn" onclick="addPhotoRow({desc0:'Inside the facility',comm0:'',desc1:'Inside the facility',comm1:'',desc2:'Inside the facility',comm2:''})">&#xFF0B; Add Photo Row (3 photos)</div>

    <div class="status-message" id="statusMessage"></div>
    <div style="margin-top:10px;">
      <div style="font-size:11px;font-weight:600;color:#555;margin-bottom:5px;">&#128247; Photo Quality</div>
      <div style="display:flex;gap:6px;">
        <button class="q-btn active" data-q="0.6" onclick="setQuality(this)">Small</button>
        <button class="q-btn" data-q="0.8" onclick="setQuality(this)">Medium</button>
        <button class="q-btn" data-q="0.92" onclick="setQuality(this)">High</button>
        <button class="q-btn" data-q="1" onclick="setQuality(this)">Full</button>
      </div>
    </div>
    <div class="action-buttons" style="margin-top:10px;">
      <button class="btn btn-secondary" onclick="saveSession()">&#128190; Save Session</button>
      <button class="btn btn-secondary" onclick="document.getElementById('loadSessionFile').click()">&#128194; Load Session<input type="file" id="loadSessionFile" accept=".json" style="display:none" onchange="loadSession(event)"></button>
      <button class="btn btn-secondary" onclick="document.getElementById('importPhotosFile').click()">&#128247; Import Photos<input type="file" id="importPhotosFile" accept="image/*" multiple style="display:none" onchange="importPhotos(event)"></button>
      <button class="btn btn-secondary" onclick="clearForm()">&#128260; Clear All</button>
      <button class="btn btn-primary" id="btnWord" onclick="generateWord()" disabled>&#128196; Generate Word</button>
      <button class="btn btn-primary" onclick="generatePDF()">&#128213; Generate PDF</button>
    </div>
    <div id="importSummary" style="display:none;margin-top:8px;padding:10px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;font-size:11px;color:#856404;"></div>
    <div style="text-align:center;margin-top:18px;padding-bottom:4px;">
      <a href="index.html" style="color:#888;font-size:12px;text-decoration:none;">&#8592; Back to Home</a>
    </div>
  </div>
</div>

<script>
if (sessionStorage.getItem('bulut_auth') !== '1') {
  window.location.href = 'index.html';
}
</script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(function(){
  var s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.js';
  s.onload=function(){
    var lib=(typeof window.docx!=='undefined'&&window.docx.Document)?window.docx:(typeof docx!=='undefined'&&docx.Document)?docx:null;
    if(lib){window._docxLib=lib;document.getElementById('btnWord').disabled=false;}
    
  };
  s.onerror=function(){
    var s2=document.createElement('script');
    s2.src='https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js';
    s2.onload=function(){
      var lib=(typeof window.docx!=='undefined'&&window.docx.Document)?window.docx:(typeof docx!=='undefined'&&docx.Document)?docx:null;
      if(lib){window._docxLib=lib;document.getElementById('btnWord').disabled=false;}
    };
    s2.onerror=function(){};
    document.head.appendChild(s2);
  };
  document.head.appendChild(s);
})();
</script>

<script>
/* ===================== LOGO ===================== */
const LOGO_B64 = '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';
const LOGO_SRC = 'data:image/jpeg;base64,' + LOGO_B64;

/* ===================== COMBO LISTS =====================
   Yeni seÃ§enek eklemek iÃ§in aÅŸaÄŸÄ±daki listelere tÄ±rnak iÃ§inde yeni satÄ±r ekleyin.
   Ã–rnek: 'Assembly point',
   SÄ±ralama alfabetik veya istediÄŸiniz gibi olabilir.
   ======================================================= */

const DESC_OPTIONS = [
  'Inside the facility',
  'Outside the facility',
];

const COMM_OPTIONS = [
  'An employee with his PPE',
  'Anti-slippery bands',
  'Assembly point',
  'Body and eye wash station',
  'Boiler room',
  'BSCI COC',
  'BSCI Speak for Change poster',
  'Chemical spill kit',
  'Chemical warehouse',
  'Combined',
  'Compressor room',
  'Cutting section',
  'Disinfectant',
  'Doctor room',
  'Dye preparation section',
  'Dyeing section',
  'Ear plugs',
  'Electricity meter',
  'Electricity panel',
  'Embroidery section',
  'Emergency case equipment',
  'Emergency exit door',
  'Emergency exit route',
  'Emergency exit sign',
  'Emergency lighting',
  'Emergency stop button',
  'Evacuation plan',
  'Eye guard on overlock machine',
  'Eye wash solutions',
  'Eye wash station',
  'Facility sign',
  'Finger guard on sewing machine',
  'Finishing section',
  'Fire alarm button',
  'Fire alarm control panel',
  'Fire extinguisher',
  'Fire hose cabinet',
  'Fire hydrant',
  'Fire-escape stairs',
  'Firefighting system for the hood',
  'First aid box',
  'First aid materials',
  'Flow-meter',
  'Gas detector',
  'Generator',
  'Hazardous waste storage area',
  'Ironing section',
  'Kitchen',
  'Knitting section',
  'Loading / Unloading area',
  'Locker room',
  'Lunch hall',
  'MSDS',
  'Non-hazardous waste storage area',
  'Notice board',
  'Packaging section',
  'Potable water',
  'PPE',
  'Prayer room',
  'Printing section',
  'Production area',
  'Protective cover the on machine',
  'Quality control section',
  'Rest area',
  'Sampling section',
  'SDS summaries',
  'Secondary containment',
  'Security checkpoint',
  'Sewing section',
  'Smoke detector',
  'Sprinkler system',
  'Stain removing section',
  'Steel glove',
  'Steel toe shoes',
  'Storage area',
  'Stretcher',
  'Suggestion box',
  'The lateral view of the facility',
  'The out view of the facility',
  'The rear view of the facility',
  'Time recording device',
  'Toilet',
  'Turnstiles with time recording device',
  'Visual fire alarm',
  'Warehouse',
  'Warning signs',
  'Washing section',
  'Waste boxes',
  'Wastewater treatment unit',
  'Water meter',
  'Weaving section',
  'Yarn removing section',
  'Yarn transfer section',
];

/* ===================== GLOBALS ===================== */
let rowCount = 0;
const photoStore = {};
let dragSrcKey = null; // for block drag-to-reorder

/* ===================== HELPERS ===================== */
function formatDate(d) {
  if (!d) return '';
  const p = d.split('-');
  return p.length === 3 ? p[2]+'.'+p[1]+'.'+p[0] : d;
}
function showStatus(msg, type) {
  const el = document.getElementById('statusMessage');
  el.textContent = msg; el.className = 'status-message '+type; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 5500);
}
function validateForm() {
  if (!document.getElementById('factoryName').value || !document.getElementById('customer').value ||
      !document.getElementById('auditDate').value || !document.getElementById('reportNumber').value) {
    showStatus('Please fill in all required fields!', 'error'); return false;
  }
  if (!Object.values(photoStore).some(v => v)) {
    showStatus('Please upload at least one photo!', 'error'); return false;
  }
  return true;
}
function getFormData() {
  return {
    factoryName:  document.getElementById('factoryName').value,
    cpaOffice:    document.getElementById('cpaOffice').value,
    customer:     document.getElementById('customer').value,
    auditType:    document.getElementById('auditType').value,
    auditDate:    document.getElementById('auditDate').value,
    reportNumber: document.getElementById('reportNumber').value,
  };
}

/* Collect all current blocks in order (row by row, left to right, skip empties) */
function readInputVal(id) {
  const el = document.getElementById(id);
  if (!el) return '';
  // Try .value first, then data-value attribute as fallback
  return el.value || el.getAttribute('data-value') || '';
}

function getAllBlocks() {
  const blocks = [];
  for (let r = 1; r <= rowCount; r++) {
    const rowEl = document.getElementById('row'+r);
    if (!rowEl) continue;
    for (let i = 0; i < 3; i++) {
      const key = 'row'+r+'_'+i;
      const cell = document.getElementById('cell_'+key);
      if (!cell || cell.classList.contains('empty-cell')) continue;
      blocks.push({
        photo: photoStore[key] || null,
        desc:  readInputVal('desc_'+key),
        comm:  readInputVal('comm_'+key),
      });
    }
  }
  return blocks;
}

function getRows() {
  const blocks = getAllBlocks();
  const rows = [];
  for (let i = 0; i < blocks.length; i += 3) rows.push(blocks.slice(i, i+3));
  // pad last row to 3
  if (rows.length > 0) {
    while (rows[rows.length-1].length < 3) rows[rows.length-1].push({ photo: null, desc: '', comm: '' });
  }
  return rows;
}

/* ===================== COMBO INPUT ===================== */
const _isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent) || navigator.maxTouchPoints > 1;

function buildCombo(key, type, defaultValue, options) {
  const id = type+'_'+key;

  const wrapper = document.createElement('div');
  wrapper.className = 'combo-wrap';
  wrapper.style.display = 'flex';
  wrapper.style.alignItems = 'center';
  wrapper.style.position = 'relative';

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'combo-input';
  input.id = id;
  input.value = defaultValue;
  input.setAttribute('data-value', defaultValue);
  input.placeholder = type === 'desc' ? 'e.g. Inside the facility' : 'Type or pick from listâ€¦';
  input.autocomplete = 'off';
  input.style.flex = '1';

  // Mobile: start as readonly (no keyboard on tap)
  if (_isMobile) {
    input.readOnly = true;
    input.setAttribute('inputmode', 'none');
    input.classList.add('mobile-readonly');
  }

  const arrow = document.createElement('span');
  arrow.className = 'combo-arrow';
  arrow.innerHTML = 'â–¼';
  arrow.style.position = 'static';
  arrow.style.transform = 'none';
  arrow.style.marginLeft = '2px';
  arrow.style.flexShrink = '0';

  const dd = document.createElement('div');
  dd.className = 'combo-dropdown';

  function renderDropdown(filter) {
    dd.innerHTML = '';
    const f = (filter || '').toLowerCase().trim();
    let matched;
    if (!f) {
      matched = options;
    } else {
      matched = options
        .map(o => {
          const ol = o.toLowerCase();
          if (ol === f) return { o, score: 3 };
          if (ol.startsWith(f)) return { o, score: 2 };
          if (ol.includes(f)) return { o, score: 1 };
          return null;
        })
        .filter(Boolean)
        .sort((a, b) => b.score - a.score)
        .map(x => x.o);
    }
    if (matched.length === 0) {
      const nm = document.createElement('div');
      nm.className = 'combo-item no-match';
      nm.textContent = 'No suggestions â€“ just keep typing';
      dd.appendChild(nm);
    } else {
      matched.forEach(label => {
        const item = document.createElement('div');
        item.className = 'combo-item';
        item.textContent = label;
        item.addEventListener('mousedown', e => {
          e.preventDefault();
          input.value = label;
          input.setAttribute('data-value', label);
          // On mobile, go back to readonly after selection
          if (_isMobile) {
            input.readOnly = true;
            input.setAttribute('inputmode', 'none');
            input.classList.add('mobile-readonly');
            if (editBtn) { editBtn.textContent = 'âœï¸'; editBtn.classList.remove('active'); }
          }
          closeDropdown();
        });
        dd.appendChild(item);
      });
    }
  }

  function openDropdown() {
    renderDropdown(input.readOnly ? '' : input.value);
    positionDropdown();
    dd.classList.add('open');
  }

  function positionDropdown() {
    const rect = input.getBoundingClientRect();
    dd.style.left  = rect.left + 'px';
    dd.style.top   = (rect.bottom + 2) + 'px';
    dd.style.width = (rect.width + 30) + 'px';
  }

  window.addEventListener('scroll', () => { if (dd.classList.contains('open')) positionDropdown(); }, true);
  function closeDropdown() { dd.classList.remove('open'); }

  input.addEventListener('focus', () => openDropdown());
  input.addEventListener('input', () => { input.setAttribute('data-value', input.value);
    if (input.readOnly) return;
    renderDropdown(input.value); positionDropdown(); dd.classList.add('open');
  });
  input.addEventListener('blur', () => setTimeout(closeDropdown, 150));

  input.addEventListener('keydown', e => {
    if (!dd.classList.contains('open')) return;
    const items = Array.from(dd.querySelectorAll('.combo-item:not(.no-match)'));
    const hi = dd.querySelector('.combo-item.highlighted');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      const next = hi ? hi.nextElementSibling : items[0];
      if (hi) hi.classList.remove('highlighted');
      if (next && items.includes(next)) next.classList.add('highlighted');
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      const prev = hi ? hi.previousElementSibling : items[items.length - 1];
      if (hi) hi.classList.remove('highlighted');
      if (prev && items.includes(prev)) prev.classList.add('highlighted');
    } else if (e.key === 'Enter') {
      e.preventDefault();
      const h = dd.querySelector('.combo-item.highlighted');
      if (h) { input.value = h.textContent; closeDropdown(); }
    } else if (e.key === 'Escape') { closeDropdown(); }
  });

  arrow.addEventListener('mousedown', e => {
    e.preventDefault();
    dd.classList.contains('open') ? closeDropdown() : (input.focus(), openDropdown());
  });

  // Mobile edit button
  let editBtn = null;
  if (_isMobile) {
    editBtn = document.createElement('button');
    editBtn.className = 'combo-edit-btn';
    editBtn.textContent = 'âœï¸';
    editBtn.title = 'Type freely';
    editBtn.type = 'button';
    editBtn.addEventListener('mousedown', e => e.preventDefault());
    editBtn.addEventListener('click', () => {
      const isEditing = !input.readOnly;
      if (isEditing) {
        input.readOnly = true;
        input.setAttribute('inputmode', 'none');
        input.classList.add('mobile-readonly');
        editBtn.textContent = 'âœï¸';
        editBtn.classList.remove('active');
        closeDropdown();
        input.blur();
      } else {
        // Must remove readonly BEFORE focus for iOS keyboard to open
        input.readOnly = false;
        input.removeAttribute('inputmode');
        input.classList.remove('mobile-readonly');
        editBtn.textContent = 'âœ“';
        editBtn.classList.add('active');
        closeDropdown();
        setTimeout(() => { input.focus(); input.select(); }, 50);
      }
    });
  }

  wrapper.appendChild(input);
  wrapper.appendChild(arrow);
  if (editBtn) wrapper.appendChild(editBtn);
  document.body.appendChild(dd);
  return wrapper;
}

/* ===================== PHOTO ROW ===================== */
function addPhotoRow(defaults) {
  const rid = ++rowCount;
  const rowId = 'row'+rid;
  const container = document.getElementById('rowsContainer');

  const section = document.createElement('div');
  section.className = 'photo-row-section';
  section.id = rowId;

  // Row header
  const rowHeader = document.createElement('div');
  rowHeader.className = 'row-header';
  rowHeader.innerHTML = `<span class="row-number">Row ${rid}</span>
    <button class="row-delete-btn" onclick="deleteEmptyRow('${rowId}')">ðŸ—‘ Delete Row</button>`;
  section.appendChild(rowHeader);

  const photoRow = document.createElement('div');
  photoRow.className = 'photo-row';
  photoRow.id = 'photorow_'+rowId;
  section.appendChild(photoRow);
  container.appendChild(section);

  for (let i = 0; i < 3; i++) {
    const key = rowId+'_'+i;
    const desc = defaults['desc'+i] !== undefined ? defaults['desc'+i] : '';
    const comm = defaults['comm'+i] !== undefined ? defaults['comm'+i] : '';
    createBlockCell(photoRow, key, desc, comm);
  }

  // After creation, if all defaults empty, mark empties
  updateEmptyStates(rowId);
}

function createBlockCell(parentRow, key, desc, comm) {
  const cell = document.createElement('div');
  cell.className = 'photo-cell';
  cell.id = 'cell_'+key;

  // Block controls bar
  const controls = document.createElement('div');
  controls.className = 'block-controls';

  const handle = document.createElement('span');
  handle.className = 'block-drag-handle';
  handle.title = 'Drag to reorder';
  handle.innerHTML = 'â ¿';
  handle.draggable = true;
  handle.addEventListener('dragstart', e => onBlockDragStart(e, key));
  handle.addEventListener('dragend', e => onBlockDragEnd(e, key));

  const delBtn = document.createElement('button');
  delBtn.className = 'block-delete-btn';
  delBtn.textContent = 'âœ• Delete';
  delBtn.addEventListener('click', () => deleteBlock(key));

  controls.appendChild(handle);
  controls.appendChild(delBtn);

  // Photo upload area
  const wrapper = document.createElement('div');
  wrapper.className = 'photo-upload-wrapper';
  wrapper.id = 'wrap_'+key;
  wrapper.addEventListener('click', () => triggerUpload(key));
  wrapper.addEventListener('dragover', e => handleDragOver(e, key));
  wrapper.addEventListener('dragleave', e => handleDragLeave(e, key));
  wrapper.addEventListener('drop', e => handleDrop(e, key));

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.id = 'file_'+key;
  fileInput.accept = 'image/*';
  fileInput.addEventListener('change', e => handleUpload(e, key));

  const img = document.createElement('img');
  img.id = 'img_'+key;
  img.alt = '';

  const placeholder = document.createElement('div');
  placeholder.className = 'upload-placeholder';
  placeholder.innerHTML = '<span>ðŸ“·</span><p>Click or drag &amp; drop</p>';

  const removeBtn = document.createElement('button');
  removeBtn.className = 'remove-btn';
  removeBtn.innerHTML = '&#215;';
  removeBtn.addEventListener('click', e => removePhoto(e, key));

  const rotateBtn = document.createElement('button');
  rotateBtn.className = 'rotate-btn';
  rotateBtn.innerHTML = 'â†»';
  rotateBtn.title = 'Rotate 90Â°';
  rotateBtn.addEventListener('click', e => { e.stopPropagation(); rotatePhoto(key); });

  wrapper.appendChild(fileInput);
  wrapper.appendChild(img);
  wrapper.appendChild(placeholder);
  wrapper.appendChild(removeBtn);
  wrapper.appendChild(rotateBtn);

  // Meta
  const meta = document.createElement('div');
  meta.className = 'photo-meta';

  const metaDesc = document.createElement('div');
  metaDesc.className = 'meta-desc';
  const labelDesc = document.createElement('label');
  labelDesc.textContent = 'Description/Area:';
  metaDesc.appendChild(labelDesc);
  metaDesc.appendChild(buildCombo(key, 'desc', desc, DESC_OPTIONS));

  const divider = document.createElement('div');
  divider.className = 'meta-divider';

  const metaComm = document.createElement('div');
  metaComm.className = 'meta-comm';
  const labelComm = document.createElement('label');
  labelComm.textContent = 'Comments:';
  metaComm.appendChild(labelComm);
  metaComm.appendChild(buildCombo(key, 'comm', comm, COMM_OPTIONS));

  meta.appendChild(metaDesc);
  meta.appendChild(divider);
  meta.appendChild(metaComm);

  // Drag-target events on the cell itself
  cell.addEventListener('dragover', e => {
    if (dragSrcKey && dragSrcKey !== key) {
      e.preventDefault();
      cell.classList.add('drag-target');
    }
  });
  cell.addEventListener('dragleave', () => cell.classList.remove('drag-target'));
  cell.addEventListener('drop', e => {
    e.preventDefault();
    cell.classList.remove('drag-target');
    if (dragSrcKey && dragSrcKey !== key) swapBlocks(dragSrcKey, key);
  });

  cell.appendChild(controls);
  cell.appendChild(wrapper);
  cell.appendChild(meta);
  parentRow.appendChild(cell);
}

/* ===================== DRAG-TO-REORDER BLOCKS ===================== */
function onBlockDragStart(e, key) {
  dragSrcKey = key;
  setTimeout(() => {
    const cell = document.getElementById('cell_'+key);
    if (cell) cell.classList.add('dragging');
  }, 0);
  e.dataTransfer.effectAllowed = 'move';
}
function onBlockDragEnd(e, key) {
  dragSrcKey = null;
  const cell = document.getElementById('cell_'+key);
  if (cell) cell.classList.remove('dragging');
  // clean all drag-target highlights
  document.querySelectorAll('.drag-target').forEach(el => el.classList.remove('drag-target'));
}

function swapBlocks(keyA, keyB) {
  // Swap photo store
  const tempPhoto = photoStore[keyA];
  photoStore[keyA] = photoStore[keyB];
  photoStore[keyB] = tempPhoto;

  // Swap images
  const imgA = document.getElementById('img_'+keyA);
  const imgB = document.getElementById('img_'+keyB);
  const wrapA = document.getElementById('wrap_'+keyA);
  const wrapB = document.getElementById('wrap_'+keyB);
  const tempSrc = imgA.src;
  const aHas = wrapA.classList.contains('has-image');
  const bHas = wrapB.classList.contains('has-image');
  imgA.src = imgB.src; imgB.src = tempSrc;
  if (bHas) wrapA.classList.add('has-image'); else wrapA.classList.remove('has-image');
  if (aHas) wrapB.classList.add('has-image'); else wrapB.classList.remove('has-image');

  // Swap inputs
  const descA = document.getElementById('desc_'+keyA);
  const descB = document.getElementById('desc_'+keyB);
  const commA = document.getElementById('comm_'+keyA);
  const commB = document.getElementById('comm_'+keyB);
  const td = descA.value; descA.value = descB.value; descB.value = td;
  const tc = commA.value; commA.value = commB.value; commB.value = tc;
}

/* ===================== DELETE BLOCK & COMPACT ===================== */
function deleteBlock(key) {
  showConfirm('Delete this block? Others will shift left to fill the gap.', () => {
    _doDeleteBlock(key);
  });
}
function _doDeleteBlock(key) {

  // Collect ALL blocks in order, remove this one
  const allBlocks = [];
  for (let r = 1; r <= rowCount; r++) {
    const rowEl = document.getElementById('row'+r);
    if (!rowEl) continue;
    for (let i = 0; i < 3; i++) {
      const k = 'row'+r+'_'+i;
      const cell = document.getElementById('cell_'+k);
      if (!cell || cell.classList.contains('empty-cell')) continue;
      allBlocks.push({
        photo: photoStore[k] || null,
        desc:  (document.getElementById('desc_'+k)||{}).value || '',
        comm:  (document.getElementById('comm_'+k)||{}).value || '',
        key: k,
      });
    }
  }

  // Remove the deleted block
  const filtered = allBlocks.filter(b => b.key !== key);

  // Rebuild DOM: clear all rows, repopulate
  rebuildFromBlocks(filtered);
}

function rebuildFromBlocks(blocks) {
  // Clear current rows
  const container = document.getElementById('rowsContainer');
  container.innerHTML = '';
  // Clear photoStore
  Object.keys(photoStore).forEach(k => delete photoStore[k]);
  rowCount = 0;

  // Group into rows of 3
  const rows = [];
  for (let i = 0; i < blocks.length; i += 3) rows.push(blocks.slice(i, i+3));

  // Ensure at least 1 row
  if (rows.length === 0) rows.push([]);

  rows.forEach((rowBlocks, ri) => {
    const rid = ++rowCount;
    const rowId = 'row'+rid;
    const section = document.createElement('div');
    section.className = 'photo-row-section';
    section.id = rowId;

    const rowHeader = document.createElement('div');
    rowHeader.className = 'row-header';
    rowHeader.innerHTML = `<span class="row-number">Row ${rid}</span>
      <button class="row-delete-btn" onclick="deleteEmptyRow('${rowId}')">ðŸ—‘ Delete Row</button>`;
    section.appendChild(rowHeader);

    const photoRow = document.createElement('div');
    photoRow.className = 'photo-row';
    photoRow.id = 'photorow_'+rowId;
    section.appendChild(photoRow);
    container.appendChild(section);

    // Fill up to 3 cells
    for (let i = 0; i < 3; i++) {
      const key = rowId+'_'+i;
      const b = rowBlocks[i];
      if (b) {
        createBlockCell(photoRow, key, b.desc, b.comm);
        if (b.photo) {
          photoStore[key] = b.photo;
          const img = document.getElementById('img_'+key);
          const wrap = document.getElementById('wrap_'+key);
          if (img) img.src = b.photo;
          if (wrap) wrap.classList.add('has-image');
        }
      } else {
        // Empty placeholder cell
        createEmptyCell(photoRow, key);
      }
    }
  });
}

function createEmptyCell(parentRow, key) {
  const cell = document.createElement('div');
  cell.className = 'photo-cell empty-cell';
  cell.id = 'cell_'+key;
  cell.style.minHeight = '80px';
  cell.style.display = 'flex';
  cell.style.alignItems = 'center';
  cell.style.justifyContent = 'center';

  // Allow dropping onto empty cell
  cell.addEventListener('dragover', e => {
    if (dragSrcKey) { e.preventDefault(); cell.classList.add('drag-target'); }
  });
  cell.addEventListener('dragleave', () => cell.classList.remove('drag-target'));
  cell.addEventListener('drop', e => {
    e.preventDefault();
    cell.classList.remove('drag-target');
    if (dragSrcKey) moveBlockToEmpty(dragSrcKey, key, cell);
  });

  const hint = document.createElement('span');
  hint.style.cssText = 'color:#ccc;font-size:10px;';
  hint.textContent = '(empty)';
  cell.appendChild(hint);
  parentRow.appendChild(cell);
}

function moveBlockToEmpty(srcKey, destKey, destCell) {
  // Get src block data
  const photo = photoStore[srcKey] || null;
  const desc = (document.getElementById('desc_'+srcKey)||{}).value || '';
  const comm = (document.getElementById('comm_'+srcKey)||{}).value || '';

  // Replace dest empty cell with real block
  const parentRow = destCell.parentNode;
  destCell.remove();
  createBlockCell(parentRow, destKey, desc, comm);
  if (photo) {
    photoStore[destKey] = photo;
    const img = document.getElementById('img_'+destKey);
    const wrap = document.getElementById('wrap_'+destKey);
    if (img) img.src = photo;
    if (wrap) wrap.classList.add('has-image');
  }

  // Make src empty
  const srcCell = document.getElementById('cell_'+srcKey);
  if (srcCell) {
    const srcParent = srcCell.parentNode;
    srcCell.remove();
    createEmptyCell(srcParent, srcKey);
    // re-insert at same position requires knowing index â€” simpler: rebuild
  }
  // Simplest: just do a full rebuild to normalize
  const allBlocks = [];
  for (let r = 1; r <= rowCount; r++) {
    const rowEl = document.getElementById('row'+r);
    if (!rowEl) continue;
    for (let i = 0; i < 3; i++) {
      const k = 'row'+r+'_'+i;
      const cell2 = document.getElementById('cell_'+k);
      if (!cell2 || cell2.classList.contains('empty-cell')) continue;
      allBlocks.push({
        photo: photoStore[k] || null,
        desc: (document.getElementById('desc_'+k)||{}).value || '',
        comm: (document.getElementById('comm_'+k)||{}).value || '',
        key: k,
      });
    }
  }
  rebuildFromBlocks(allBlocks);
}

function updateEmptyStates(rowId) { /* no-op for now, handled by rebuild */ }

function deleteEmptyRow(rowId) {
  const section = document.getElementById(rowId);
  if (!section) return;
  // Check if any blocks in this row have content
  let hasContent = false;
  for (let i = 0; i < 3; i++) {
    const k = rowId+'_'+i;
    const cell = document.getElementById('cell_'+k);
    if (cell && !cell.classList.contains('empty-cell')) { hasContent = true; break; }
  }
  if (hasContent) {
    showConfirm('This row has content. Delete entire row and shift blocks up?', () => {
      _doDeleteRow(rowId, true);
    });
    return;
  } else {
    section.remove();
    return;
  }
}
function _doDeleteRow(rowId, hasContent) {
  const section = document.getElementById(rowId);
  if (!section) return;
  if (hasContent) {
    // Remove all blocks from this row, rebuild
    const allBlocks = [];
    for (let r = 1; r <= rowCount; r++) {
      const rEl = document.getElementById('row'+r);
      if (!rEl) continue;
      if (rEl.id === rowId) continue; // skip
      for (let i = 0; i < 3; i++) {
        const k = 'row'+r+'_'+i;
        const cell = document.getElementById('cell_'+k);
        if (!cell || cell.classList.contains('empty-cell')) continue;
        allBlocks.push({ photo: photoStore[k]||null, desc:(document.getElementById('desc_'+k)||{}).value||'', comm:(document.getElementById('comm_'+k)||{}).value||'' });
      }
    }
    rebuildFromBlocks(allBlocks);
  }
}

function deleteRow(rowId) { deleteEmptyRow(rowId); }

/* ===================== PHOTO UPLOAD ===================== */
function triggerUpload(key) { document.getElementById('file_'+key).click(); }
let _photoQuality = 0.6; // default Small

function setQuality(btn) {
  document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  _photoQuality = parseFloat(btn.dataset.q);
}

function compressDataUrl(dataUrl, cb) {
  const img = new Image();
  img.onload = () => {
    // Max dimensions by quality setting
    const maxDims = {0.6: 1200, 0.8: 1600, 0.92: 2400, 1: 99999};
    const maxW = maxDims[_photoQuality] || 1600;
    let w = img.width, h = img.height;
    if (w > maxW) { h = Math.round(h * maxW / w); w = maxW; }
    if (h > maxW) { w = Math.round(w * maxW / h); h = maxW; }
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    c.getContext('2d').drawImage(img, 0, 0, w, h);
    const q = _photoQuality >= 1 ? 1 : _photoQuality;
    cb(c.toDataURL('image/jpeg', q));
  };
  img.src = dataUrl;
}

function autoRotate90Left(dataUrl, cb) {
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    canvas.width = img.height;
    canvas.height = img.width;
    const ctx = canvas.getContext('2d');
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(-0.5 * Math.PI);
    ctx.drawImage(img, -img.width / 2, -img.height / 2);
    cb(canvas.toDataURL('image/jpeg', _photoQuality < 1 ? _photoQuality : 0.92));
  };
  img.src = dataUrl;
}

function setPhotoData(key, dataUrl) {
  compressDataUrl(dataUrl, compressed => {
    autoRotate90Left(compressed, rotated => {
      photoStore[key] = rotated;
      document.getElementById('img_'+key).src = rotated;
      document.getElementById('wrap_'+key).classList.add('has-image');
    });
  });
}
function applyOrientationAndCallback(img, orientation, callback) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const w = img.width, h = img.height;
  if (orientation >= 5 && orientation <= 8) {
    canvas.width = h; canvas.height = w;
  } else {
    canvas.width = w; canvas.height = h;
  }
  switch(orientation) {
    case 2: ctx.translate(w,0); ctx.scale(-1,1); break;
    case 3: ctx.translate(w,h); ctx.rotate(Math.PI); break;
    case 4: ctx.translate(0,h); ctx.scale(1,-1); break;
    case 5: ctx.rotate(0.5*Math.PI); ctx.scale(1,-1); break;
    case 6: ctx.rotate(0.5*Math.PI); ctx.translate(0,-h); break;
    case 7: ctx.rotate(0.5*Math.PI); ctx.translate(w,-h); ctx.scale(-1,1); break;
    case 8: ctx.rotate(-0.5*Math.PI); ctx.translate(-w,0); break;
    default: break;
  }
  ctx.drawImage(img, 0, 0, w, h);
  callback(canvas.toDataURL('image/jpeg', _photoQuality < 1 ? _photoQuality : 0.92));
}

function fixImageOrientation(file, callback) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    const img = new Image();
    img.onload = function() {
      try {
        EXIF.getData(img, function() {
          const orientation = EXIF.getTag(this, 'Orientation') || 1;
          applyOrientationAndCallback(img, orientation, callback);
        });
      } catch(err) {
        console.warn('EXIF failed, using default orientation', err);
        applyOrientationAndCallback(img, 1, callback);
      }
    };
    img.src = dataUrl;
  };
  reader.readAsDataURL(file);
}
function handleUpload(event, key) {
  const file = event.target.files[0]; if (!file) return;
  fixImageOrientation(file, function(fixedBase64) {
    setPhotoData(key, fixedBase64);
  });
}
function handleDragOver(event, key) {
  // Only for photo drag (files), not block reorder
  if (event.dataTransfer.types.includes('Files')) {
    event.preventDefault(); event.stopPropagation();
    document.getElementById('wrap_'+key).classList.add('drag-over');
  }
}
function handleDragLeave(event, key) {
  event.stopPropagation();
  document.getElementById('wrap_'+key).classList.remove('drag-over');
}
function handleDrop(event, key) {
  if (!event.dataTransfer.types.includes('Files')) return;
  event.preventDefault(); event.stopPropagation();
  document.getElementById('wrap_'+key).classList.remove('drag-over');
  const file = event.dataTransfer.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  fixImageOrientation(file, function(fixedBase64) {
    setPhotoData(key, fixedBase64);
  });
}
function rotatePhoto(key) {
  const dataUrl = photoStore[key];
  if (!dataUrl) return;
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    canvas.width = img.height;
    canvas.height = img.width;
    const ctx = canvas.getContext('2d');
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(0.5 * Math.PI);
    ctx.drawImage(img, -img.width / 2, -img.height / 2);
    const rotated = canvas.toDataURL('image/jpeg', _photoQuality < 1 ? _photoQuality : 0.92);
    photoStore[key] = rotated;
    document.getElementById('img_' + key).src = rotated;
  };
  img.src = dataUrl;
}

function removePhoto(event, key) {
  event.stopPropagation();
  photoStore[key] = null;
  document.getElementById('img_'+key).src = '';
  document.getElementById('file_'+key).value = '';
  document.getElementById('wrap_'+key).classList.remove('has-image');
}

/* ===================== WORD ===================== */
async function generateWord() {
  if (!validateForm()) return;
  const lib = window._docxLib ||
              (typeof window.docx !== 'undefined' && window.docx.Document ? window.docx : null) ||
              (typeof docx !== 'undefined' && docx.Document ? docx : null);
  if (!lib) { showStatus('Word library not ready. Please wait and retry.', 'error'); return; }
  showStatus('Generating Word document...', 'success');
  try {
    const { Document, Paragraph, Table, TableCell, TableRow, WidthType, TextRun,
            AlignmentType, ImageRun, BorderStyle, ShadingType, VerticalAlign, Packer, PageNumber } = lib;
    const fd = getFormData();
    const rows = getRows();
    const pageW=11906, mL=720, mR=720, mT=900, mB=900;
    const contentW = pageW - mL - mR;
    const bThin = { style: BorderStyle.SINGLE, size: 4, color: '000000' };
    const bAll  = { top: bThin, bottom: bThin, left: bThin, right: bThin };
    const bNone = { style: BorderStyle.NONE, size: 0, color: 'FFFFFF' };
    const bNA   = { top: bNone, bottom: bNone, left: bNone, right: bNone };
    const logoBytes = Uint8Array.from(atob(LOGO_B64), c => c.charCodeAt(0));

    const hdrTable = new Table({
      width: { size: contentW, type: WidthType.DXA },
      columnWidths: [Math.floor(contentW*0.55), Math.ceil(contentW*0.45)],
      borders: { top: bNone, bottom: bNone, left: bNone, right: bNone, insideH: bNone, insideV: bNone },
      rows: [new TableRow({ children: [
        new TableCell({ borders: bNA, width: { size: Math.floor(contentW*0.55), type: WidthType.DXA },
          children: [new Paragraph({ children: [new ImageRun({ data: logoBytes, transformation: { width: 150, height: 42 }, type: 'jpg' })] })] }),
        new TableCell({ borders: bNA, width: { size: Math.ceil(contentW*0.45), type: WidthType.DXA },
          verticalAlign: VerticalAlign.CENTER,
          children: [new Paragraph({ alignment: AlignmentType.RIGHT,
            children: [new TextRun({ text: 'Code: AU_TP_042, Ver 2.0', font: 'Calibri', size: 20, color: '999999' })] })] })
      ]})]
    });

    const lw1=1600, vw1=4900, lw2=1400, vw2=2566;
    function mkL(text, w) {
      return new TableCell({ borders: bAll, width: { size: w, type: WidthType.DXA },
        shading: { fill: 'E26B0A', type: ShadingType.CLEAR },
        margins: { top: 40, bottom: 40, left: 60, right: 60 },
        verticalAlign: VerticalAlign.CENTER,
        children: [new Paragraph({ alignment: AlignmentType.CENTER,
          children: [new TextRun({ text, font: 'Calibri', size: 18, bold: true, color: '000000' })] })] });
    }
    function mkV(text, w) {
      return new TableCell({ borders: bAll, width: { size: w, type: WidthType.DXA },
        margins: { top: 40, bottom: 40, left: 80, right: 80 },
        verticalAlign: VerticalAlign.CENTER,
        children: [new Paragraph({ children: [new TextRun({ text, font: 'Calibri', size: 18 })] })] });
    }

    const infoTable = new Table({
      width: { size: contentW, type: WidthType.DXA },
      columnWidths: [lw1, vw1, lw2, vw2],
      rows: [
        new TableRow({ children: [new TableCell({ borders: bAll, columnSpan: 4,
          shading: { fill: '17375E', type: ShadingType.CLEAR },
          margins: { top: 50, bottom: 50, left: 80, right: 80 },
          children: [new Paragraph({ alignment: AlignmentType.CENTER,
            children: [new TextRun({ text: 'Audit - Photos Report', font: 'Calibri', size: 22, bold: true, color: 'FFFFFF' })] })] })] }),
        new TableRow({ children: [mkL('Factory Name',lw1), mkV(fd.factoryName,vw1), mkL('Audit type',lw2), mkV(fd.auditType,vw2)] }),
        new TableRow({ children: [mkL('Eurofins CPA Office',lw1), mkV(fd.cpaOffice,vw1), mkL('Audit date',lw2), mkV(fd.auditDate,vw2)] }),
        new TableRow({ children: [mkL('Customer',lw1), mkV(fd.customer,vw1), mkL('Report number',lw2), mkV(fd.reportNumber,vw2)] }),
      ]
    });

    const cw = Math.floor(contentW / 3);
    const cw3 = contentW - cw * 2;
    const photoChildren = [];

    for (const rowCols of rows) {
      const photoCells = rowCols.map((col, idx) => {
        const w = idx < 2 ? cw : cw3;
        const imgRun = col.photo ? new ImageRun({
          data: Uint8Array.from(atob(col.photo.split(',')[1]), c => c.charCodeAt(0)),
          transformation: { width: 210, height: 158 },
          type: col.photo.startsWith('data:image/png') ? 'png' : 'jpg'
        }) : null;
        return new TableCell({ borders: bAll, width: { size: w, type: WidthType.DXA },
          margins: { top: 20, bottom: 20, left: 20, right: 20 },
          children: [new Paragraph({ alignment: AlignmentType.CENTER,
            children: imgRun ? [imgRun] : [new TextRun('')] })] });
      });

      const bDescBottom = { top: bThin, bottom: bThin, left: bThin, right: bThin, insideH: bThin, insideV: bThin };
      const descCells = rowCols.map((col, idx) => {
        const w = idx < 2 ? cw : cw3;
        return new TableCell({ borders: bAll, width: { size: w, type: WidthType.DXA },
          margins: { top: 40, bottom: 0, left: 80, right: 80 },
          children: [new Paragraph({ spacing: { before: 0, after: 0 },
            children: [new TextRun({ text: 'Description/Area: '+col.desc, font: 'Calibri', size: 18, color: '000000' })] })] });
      });
      const commCells = rowCols.map((col, idx) => {
        const w = idx < 2 ? cw : cw3;
        return new TableCell({ borders: bAll, width: { size: w, type: WidthType.DXA },
          margins: { top: 0, bottom: 40, left: 80, right: 80 },
          children: [new Paragraph({ spacing: { before: 0, after: 0 },
            children: [new TextRun({ text: 'Comments: '+col.comm, font: 'Calibri', size: 18, color: '000000' })] })] });
      });

      photoChildren.push(new Table({
        width: { size: contentW, type: WidthType.DXA },
        columnWidths: [cw, cw, cw3],
        rows: [new TableRow({ children: photoCells }), new TableRow({ children: descCells }), new TableRow({ children: commCells })]
      }));
      photoChildren.push(new Paragraph({ spacing: { after: 40 } }));
    }

    const footerPara = new Paragraph({ children: [
      new TextRun({ text: 'Audit \u2013 Photos Report: '+fd.reportNumber+'.docx , Page ', font: 'Calibri', size: 20, color: '999999' }),
      new TextRun({ children: [PageNumber.CURRENT], font: 'Calibri', size: 20, color: '999999' }),
      new TextRun({ text: ' of ', font: 'Calibri', size: 20, color: '999999' }),
      new TextRun({ children: [PageNumber.TOTAL_PAGES], font: 'Calibri', size: 20, color: '999999' }),
    ] });

    const doc = new Document({
      sections: [{ properties: { page: { size: { width: pageW, height: 16838 }, margin: { top: mT, right: mR, bottom: mB, left: mL } } },
        headers: { default: { options: { children: [hdrTable, new Paragraph({ spacing: { after: 80 } })] } } },
        footers: { default: { options: { children: [footerPara] } } },
        children: [infoTable, new Paragraph({ spacing: { after: 100 } }), ...photoChildren] }]
    });

    const blob = await Packer.toBlob(doc);
    saveAs(blob, 'Photo_Report_'+fd.reportNumber+'.docx');
    showStatus('Word document generated!', 'success');
  } catch(e) { console.error(e); showStatus('Error (Word): '+e.message, 'error'); }
}

/* ===================== PDF ===================== */
function generatePDF() {
  if (!validateForm()) return;
  showStatus('Generating PDF...', 'success');
  try {
    const { jsPDF } = window.jspdf;
    const fd = getFormData();
    const rows = getRows();
    const W=595.28, mg=28;
    const tblW = W - mg*2;
    const photoW = tblW / 3;
    const photoH = photoW * 0.75;
    const metaH = 26;
    const pageStart=50, pageEnd=820;

    function calcPages() {
      let y = pageStart + 16 + 14*3 + 7;
      let p = 1;
      for (const rc of rows) {
        if (y + photoH + metaH > pageEnd) { p++; y = pageStart; }
        y += photoH + metaH;
      }
      return p;
    }
    const totalPages = calcPages();
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    let curPage = 1;

    function drawHdr() {
      doc.addImage(LOGO_SRC,'JPEG',mg,8,110,31);
      doc.setFont('helvetica','normal'); doc.setFontSize(7.5);
      doc.setTextColor(160,160,160);
      doc.text('Code: AU_TP_042, Ver 2.0', W-mg, 21, { align:'right' });
    }
    function drawFtr(p) {
      doc.setFont('helvetica','normal'); doc.setFontSize(7.5);
      doc.setTextColor(160,160,160);
      doc.text('Audit \u2013 Photos Report: '+fd.reportNumber+'.docx , Page '+p+' of '+totalPages, mg, 835);
    }
    function nextPage() { drawFtr(curPage); doc.addPage(); curPage++; drawHdr(); return pageStart; }

    drawHdr();
    let y = pageStart;

    const titleH=16, rH=14;
    doc.setFillColor(23,55,94); doc.setDrawColor(0,0,0); doc.setLineWidth(0.5);
    doc.rect(mg, y, tblW, titleH, 'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(255,255,255);
    doc.text('Audit - Photos Report', W/2, y+11, { align:'center' });
    y += titleH;

    const lw1p=tblW*0.15, vw1p=tblW*0.45, lw2p=tblW*0.15, vw2p=tblW*0.25;
    const infoRows = [
      ['Factory Name', fd.factoryName, 'Audit type', fd.auditType],
      ['Eurofins CPA Office', fd.cpaOffice, 'Audit date', fd.auditDate],
      ['Customer', fd.customer, 'Report number', fd.reportNumber],
    ];
    doc.setFontSize(7.5);
    infoRows.forEach(row => {
      let x = mg;
      doc.setFillColor(226,107,10); doc.setDrawColor(0,0,0); doc.setLineWidth(0.5);
      doc.rect(x, y, lw1p, rH, 'FD');
      doc.setFont('helvetica','bold'); doc.setTextColor(0,0,0);
      doc.text(row[0], x+(lw1p-doc.getTextWidth(row[0]))/2, y+9.5);
      x += lw1p;
      doc.setFillColor(255,255,255); doc.rect(x, y, vw1p, rH, 'FD');
      doc.setFont('helvetica','normal');
      doc.splitTextToSize(String(row[1]), vw1p-6).forEach((ln,i) => doc.text(ln, x+3, y+9.5+i*8.5));
      x += vw1p;
      doc.setFillColor(226,107,10); doc.rect(x, y, lw2p, rH, 'FD');
      doc.setFont('helvetica','bold');
      doc.text(row[2], x+(lw2p-doc.getTextWidth(row[2]))/2, y+9.5);
      x += lw2p;
      doc.setFillColor(255,255,255); doc.rect(x, y, vw2p, rH, 'FD');
      doc.setFont('helvetica','normal');
      doc.splitTextToSize(String(row[3]), vw2p-6).forEach((ln,i) => doc.text(ln, x+3, y+9.5+i*8.5));
      y += rH;
    });
    y += 6;

    for (const rowCols of rows) {
      const blockH = photoH + metaH;
      if (y + blockH > pageEnd) { y = nextPage(); }
      for (let i=0; i<3; i++) {
        const col = rowCols[i]; const x = mg + i*photoW;
        if (col.photo) {
          const fmt = col.photo.startsWith('data:image/png')?'PNG':'JPEG';
          const pad = 6;
	try { doc.addImage(col.photo, fmt, x+pad, y, photoW-pad*2, photoH); } catch(e){}
        }
        doc.setDrawColor(0,0,0); doc.setLineWidth(0.5);
        doc.rect(x, y, photoW, photoH, col.photo ? 'D' : 'S');
      }
      y += photoH;
      for (let i=0; i<3; i++) {
        const col = rowCols[i]; const x = mg + i*photoW;
        doc.setFillColor(255,255,255); doc.setDrawColor(0,0,0); doc.setLineWidth(0.5);
        doc.rect(x, y, photoW, metaH, 'FD');
        doc.setFont('helvetica','normal'); doc.setFontSize(7.5); doc.setTextColor(0,0,0);
        doc.text('Description/Area: '+(col.desc||''), x+3, y+11, { maxWidth: photoW-6 });
        doc.setDrawColor(0,0,0); doc.setLineWidth(0.3);
        doc.line(x+1, y+13, x+photoW-1, y+13);
        doc.text('Comments: '+(col.comm||''), x+3, y+24, { maxWidth: photoW-6 });
      }
      y += metaH;
    }

    drawFtr(curPage);
    doc.save('Photo_Report_'+fd.reportNumber+'.pdf');
    showStatus('PDF generated!', 'success');
  } catch(e) { console.error(e); showStatus('Error (PDF): '+e.message, 'error'); }
}

/* ===================== CLEAR / INIT ===================== */
function clearForm() {
  showConfirm('Clear all data? This cannot be undone.', () => {
    _doClearForm();
  }, 'Clear All');
}
function _doClearForm() {
  document.getElementById('rowsContainer').innerHTML = '';
  Object.keys(photoStore).forEach(k => delete photoStore[k]);
  rowCount = 0; initRows();
  showStatus('Cleared!', 'success');
}

function initRows() {
  addPhotoRow({
    desc0:'Outside the facility', comm0:'The out view of the facility',
    desc1:'Outside the facility', comm1:'The out view of the facility',
    desc2:'Outside the facility', comm2:'The out view of the facility'
  });
  addPhotoRow({desc0:'Inside the facility',comm0:'',desc1:'Inside the facility',comm1:'',desc2:'Inside the facility',comm2:''});
}

(function(){
  const inp = document.getElementById('auditType');
  const dd  = document.getElementById('auditTypeDropdown');
  const arr = inp.parentElement.querySelector('.combo-arrow');
  function pos(){ const r=inp.getBoundingClientRect(); dd.style.left=r.left+'px'; dd.style.top=(r.bottom+2)+'px'; dd.style.width=r.width+'px'; }
  function open(){ pos(); dd.classList.add('open'); }
  function close(){ dd.classList.remove('open'); }
  inp.addEventListener('focus', open);
  inp.addEventListener('blur', ()=>setTimeout(close,150));
  arr.addEventListener('mousedown', e=>{ e.preventDefault(); dd.classList.contains('open')?close():(inp.focus(),open()); });
  window.addEventListener('scroll', ()=>{ if(dd.classList.contains('open')) pos(); }, true);
})();

function pickAuditType(val){
  document.getElementById('auditType').value = val;
  document.getElementById('auditTypeDropdown').classList.remove('open');
}

document.getElementById('auditDate').value = new Date().toLocaleDateString('tr-TR').replace(/\//g, '.');
initRows();

/* ===================== SAVE / LOAD SESSION ===================== */
function saveSession() {
  const fd = {
    factoryName:  document.getElementById('factoryName').value,
    cpaOffice:    document.getElementById('cpaOffice').value,
    customer:     document.getElementById('customer').value,
    auditType:    document.getElementById('auditType').value,
    auditDate:    document.getElementById('auditDate').value,
    reportNumber: document.getElementById('reportNumber').value,
  };
  const blocks = [];
  for (let r = 1; r <= rowCount; r++) {
    const rowEl = document.getElementById('row'+r);
    if (!rowEl) continue;
    for (let i = 0; i < 3; i++) {
      const k = 'row'+r+'_'+i;
      const cell = document.getElementById('cell_'+k);
      if (!cell || cell.classList.contains('empty-cell')) continue;
      blocks.push({
        photo: photoStore[k] || null,
        desc:  (document.getElementById('desc_'+k)||{}).value || '',
        comm:  (document.getElementById('comm_'+k)||{}).value || '',
      });
    }
  }
  const session = { formData: fd, blocks };
  const blob = new Blob([JSON.stringify(session)], { type: 'application/json' });
  saveAs(blob, 'session_' + (fd.reportNumber || 'audit') + '.json');
  showStatus('Session saved!', 'success');
}

function loadSession(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const session = JSON.parse(e.target.result);
      const fd = session.formData || {};
      document.getElementById('factoryName').value  = fd.factoryName  || '';
      document.getElementById('cpaOffice').value    = fd.cpaOffice    || '';
      document.getElementById('customer').value     = fd.customer     || '';
      document.getElementById('auditType').value    = fd.auditType    || '';
      document.getElementById('auditDate').value    = fd.auditDate    || '';
      document.getElementById('reportNumber').value = fd.reportNumber || '';
      rebuildFromBlocks(session.blocks || []);
      showStatus('Session loaded!', 'success');
    } catch(err) {
      showStatus('Error loading session: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

/* ===================== IMPORT PHOTOS ===================== */

const OUTSIDE_COMMS = [
  'the out view of the facility','the lateral view of the facility','the rear view of the facility',
  'facility sign','security checkpoint',
  'hazardous waste storage area','non-hazardous waste storage area','non-hazardous waste storage container',
  'wastewater treatment unit','generator','boiler room','compressor room','assembly point',
];

const IMPORT_ORDER = [
  'The out view of the facility','The lateral view of the facility','The rear view of the facility','Facility sign','Security checkpoint',
  'Cutting section','Sewing section','Knitting section','Weaving section','Dyeing section','Dye preparation section',
  'Printing section','Embroidery section','Finishing section','Ironing section','Stain removing section','Washing section',
  'Packaging section','Sampling section','Quality control section','Production area','Yarn removing section','Yarn transfer section',
  'Loading / Unloading area','Storage area','Warehouse',
  'Emergency exit door','Emergency exit route','Emergency exit sign','Emergency lighting','Emergency stop button',
  'Fire-escape stairs','Fire extinguisher','Fire hose cabinet','Fire hydrant','Fire alarm button','Fire alarm control panel',
  'Firefighting system for the hood','Sprinkler system','Smoke detector','Visual fire alarm','Gas detector',
  'First aid box','First aid materials','Emergency case equipment','Stretcher',
  'Eye wash station','Eye wash solutions','Body and eye wash station','Evacuation plan',
  'Eye guard on overlock machine','Finger guard on sewing machine','Protective cover the on machine',
  'Anti-slippery bands','Warning signs','PPE box','PPE','An employee with his PPE','Steel glove','Steel toe shoes','Ear plugs',
  'Chemical warehouse','Chemical spill kit','Secondary containment','MSDS','SDS summaries','Disinfectant','Waste boxes','Waste box',
  'Notice board','Suggestion box','BSCI COC','BSCI Speak for Change poster','Locker room','Lunch hall','Kitchen',
  'Toilet','Rest area','Prayer room','Doctor room','Time recording device','Turnstiles with time recording device',
  'Electricity panel','Electricity meter','Water meter','Potable water','Flow-meter',
  'Hazardous waste storage area','Non-hazardous waste storage area','Non-hazardous waste storage container',
  'Wastewater treatment unit','Generator','Boiler room','Compressor room',
  'Assembly point',
];

function importPhotos(event) {
  const files = Array.from(event.target.files);
  event.target.value = '';
  if (!files.length) return;

  function parseFilename(file) {
    let name = file.name.replace(/\.[^.]+$/, '');
    let num = 1;
    const m = name.match(/^(.+?)_(\d+)$/);
    if (m) { name = m[1]; num = parseInt(m[2]); }
    return { label: name, num };
  }

  const commMap = {};
  COMM_OPTIONS.forEach(opt => { commMap[opt.toLowerCase()] = opt; });

  const groups = {};
  const unmatched = [];

  files.forEach(file => {
    const { label, num } = parseFilename(file);
    const matched = commMap[label.toLowerCase()];
    if (matched) {
      if (!groups[matched]) groups[matched] = [];
      groups[matched].push({ file, num });
    } else {
      unmatched.push(file.name);
    }
  });

  Object.keys(groups).forEach(k => groups[k].sort((a,b) => a.num - b.num));

  const orderedKeys = [];
  IMPORT_ORDER.forEach(opt => { if (groups[opt]) orderedKeys.push(opt); });
  Object.keys(groups).forEach(k => { if (!IMPORT_ORDER.includes(k)) orderedKeys.push(k); });

  const newBlocks = [];
  orderedKeys.forEach(commLabel => {
    groups[commLabel].forEach(({ file }) => {
      const desc = OUTSIDE_COMMS.includes(commLabel.toLowerCase())
        ? 'Outside the facility'
        : 'Inside the facility';
      newBlocks.push({ file, comm: commLabel, desc });
    });
  });

  if (!newBlocks.length) {
    showStatus('No matching photos found!', 'error');
    return;
  }

  let loaded = 0;
  const blockData = newBlocks.map(b => ({ comm: b.comm, desc: b.desc, photo: null }));

  newBlocks.forEach((b, idx) => {
    fixImageOrientation(b.file, function(fixedBase64) {
      blockData[idx].photo = fixedBase64;
      loaded++;
      if (loaded === newBlocks.length) {
        rebuildFromBlocks(blockData);
        const summary = document.getElementById('importSummary');
        let msg = '&#10003; ' + newBlocks.length + ' photo(s) imported across ' + Math.ceil(newBlocks.length/3) + ' row(s).';
        if (unmatched.length) {
          msg += '<br>&#9888; ' + unmatched.length + ' file(s) not matched: <em>' + unmatched.join(', ') + '</em>';
        }
        summary.innerHTML = msg;
        summary.style.display = 'block';
        setTimeout(() => summary.style.display = 'none', 12000);
        showStatus('Photos imported!', 'success');
      }
    });
  });
}

/* ===================== REORGANIZE BLOCKS ===================== */
function reorganizeBlocks() {
  // Collect all current blocks
  const allBlocks = [];
  for (let r = 1; r <= rowCount; r++) {
    const rowEl = document.getElementById('row'+r);
    if (!rowEl) continue;
    for (let i = 0; i < 3; i++) {
      const k = 'row'+r+'_'+i;
      const cell = document.getElementById('cell_'+k);
      if (!cell || cell.classList.contains('empty-cell')) continue;
      const comm = (document.getElementById('comm_'+k)||{}).value || '';
      const desc = (document.getElementById('desc_'+k)||{}).value || '';
      const photo = photoStore[k] || null;
      allBlocks.push({ comm, desc, photo });
    }
  }

  if (!allBlocks.length) {
    showStatus('No blocks to reorganize!', 'error');
    return;
  }

  // Sort by IMPORT_ORDER, unrecognized go to end
  const orderMap = {};
  IMPORT_ORDER.forEach((item, idx) => { orderMap[item.toLowerCase()] = idx; });

  allBlocks.sort((a, b) => {
    const ia = orderMap[a.comm.toLowerCase()];
    const ib = orderMap[b.comm.toLowerCase()];
    const scoreA = ia !== undefined ? ia : 99999;
    const scoreB = ib !== undefined ? ib : 99999;
    return scoreA - scoreB;
  });

  // Update desc based on OUTSIDE_COMMS
  allBlocks.forEach(b => {
    if (OUTSIDE_COMMS.includes(b.comm.toLowerCase())) {
      b.desc = 'Outside the facility';
    } else if (b.desc === '') {
      b.desc = 'Inside the facility';
    }
  });

  rebuildFromBlocks(allBlocks);
  showStatus('Blocks reorganized!', 'success');
}


/* ===================== UPLOAD PHOTOS ===================== */
function uploadPhotos(event) {
  const files = Array.from(event.target.files);
  event.target.value = '';
  if (!files.length) return;

  const needed = files.length;
  // Count available empty slots
  let emptyCount = 0;
  for (let r = 1; r <= rowCount; r++) {
    const rowEl = document.getElementById('row'+r);
    if (!rowEl) continue;
    for (let i = 0; i < 3; i++) {
      const k = 'row'+r+'_'+i;
      const cell = document.getElementById('cell_'+k);
      if (cell && !cell.classList.contains('empty-cell') && !photoStore[k]) emptyCount++;
    }
  }
  const newRowsNeeded = Math.max(0, Math.ceil((needed - emptyCount) / 3));
  for (let r = 0; r < newRowsNeeded; r++) {
    addPhotoRow({desc0:'Inside the facility',comm0:'',desc1:'Inside the facility',comm1:'',desc2:'Inside the facility',comm2:''});
  }

  // Collect all empty slots
  const allSlots = [];
  for (let r = 1; r <= rowCount; r++) {
    const rowEl = document.getElementById('row'+r);
    if (!rowEl) continue;
    for (let i = 0; i < 3; i++) {
      const k = 'row'+r+'_'+i;
      const cell = document.getElementById('cell_'+k);
      if (cell && !cell.classList.contains('empty-cell') && !photoStore[k]) allSlots.push(k);
    }
  }

  files.forEach((file, idx) => {
    if (idx >= allSlots.length) return;
    const key = allSlots[idx];
    fixImageOrientation(file, function(fixedBase64) {
      setPhotoData(key, fixedBase64);
    });
  });

  showStatus(files.length + ' photo(s) uploaded!', 'success');
}
/* ===================== CUSTOM CONFIRM MODAL ===================== */
let _confirmSkip = false;

function showConfirm(msg, onOk, okLabel) {
  if (_confirmSkip) { onOk(); return; }
  const modal = document.getElementById('confirmModal');
  document.getElementById('confirmMsg').textContent = msg;
  document.getElementById('confirmOk').textContent = okLabel || 'Delete';
  document.getElementById('confirmDontAskChk').checked = false;
  modal.classList.add('open');

  function cleanup() {
    modal.classList.remove('open');
    document.getElementById('confirmOk').removeEventListener('click', handleOk);
    document.getElementById('confirmCancel').removeEventListener('click', handleCancel);
    modal.removeEventListener('click', handleBackdrop);
  }
  function handleOk() {
    if (document.getElementById('confirmDontAskChk').checked) _confirmSkip = true;
    cleanup();
    onOk();
  }
  function handleCancel() { cleanup(); }
  function handleBackdrop(e) { if (e.target === modal) cleanup(); }

  document.getElementById('confirmOk').addEventListener('click', handleOk);
  document.getElementById('confirmCancel').addEventListener('click', handleCancel);
  modal.addEventListener('click', handleBackdrop);
}
</script>

<div id="confirmModal">
  <div id="confirmBox">
    <p id="confirmMsg">Are you sure?</p>
    <label id="confirmDontAsk"><input type="checkbox" id="confirmDontAskChk"> Don't ask again this session</label>
    <div id="confirmBtns">
      <button id="confirmCancel">Cancel</button>
      <button id="confirmOk">Delete</button>
    </div>
  </div>
</div>
</body>
</html>
